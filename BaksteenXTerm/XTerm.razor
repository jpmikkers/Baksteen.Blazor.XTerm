@inject IJSRuntime jsRuntime
@implements IAsyncDisposable

<link href="_content/BaksteenXTerm/css/xterm.css" rel="stylesheet" />
<div @ref="_terminalElementReference" id="@_resolvedId"></div>

@code {

    [Parameter] public string? Id { get; set; }
    private string _resolvedId = string.Empty;

    protected override void OnInitialized()
    {
        _resolvedId = Id ?? $"xterm-{Guid.NewGuid()}";
    }

    private DotNetObjectReference<XTerm>? _dotNetRef;
    private ElementReference _terminalElementReference;

    private IJSObjectReference? module;
    private IJSObjectReference? terminal;
    private IJSObjectReference? xtermInteropHelper;
    private IAsyncDisposable? onKeySubscription;
    private IAsyncDisposable? onDataSubscription;
    private IAsyncDisposable? onSelectionChangeSubscription;

    public record class KeyEventPayload
    {
        public string Key { get; set; } = string.Empty;
        public string Code { get; set; } = string.Empty;
        public bool Ctrl { get; set; }
        public bool Alt { get; set; }
        public bool Shift { get; set; }
        public bool Meta { get; set; }
    }

    // Selection position DTOs for JSON deserialization from JS interop
    public class BufferCellPosition
    {
        public int X { get; set; }
        public int Y { get; set; }
    }

    public class BufferRange
    {
        public BufferCellPosition? Start { get; set; }
        public BufferCellPosition? End { get; set; }
    }

    public record class SelectionChangePayload
    {
        public bool HasSelection { get; set; }
        public string? Selection { get; set; }
        public BufferRange? Position { get; set; }
    }

    [JSInvokable]
    public async Task OnTerminalData(string data)
    {
        await Write($"got data {data}");
    }

    [JSInvokable]
    public async Task OnTerminalKey(KeyEventPayload e)
    {
        await Write($"got key {e}");
    }

    [JSInvokable]
    public async Task OnSelectionChange(SelectionChangePayload payload)
    {
        // Example behavior: write a short notification to the terminal.
        // You can replace this with custom handling or event dispatching as needed.
        var msg = payload is null
            ? "selection changed (null payload)"
            : $"selection changed len={(payload.Selection?.Length ?? 0)}";
        await Write(msg);
    }

    private async Task<IAsyncDisposable> RegisterOnKey()
    {
        if(xtermInteropHelper is null) throw new InvalidOperationException("XTerm interop helper is not initialized.");
        return new JSDisposeHelper(await xtermInteropHelper.InvokeAsync<IJSObjectReference>("registerOnKey", _dotNetRef));
    }

    private async Task<IAsyncDisposable> RegisterOnData()
    {
        if(xtermInteropHelper is null) throw new InvalidOperationException("XTerm interop helper is not initialized.");
        return new JSDisposeHelper(await xtermInteropHelper.InvokeAsync<IJSObjectReference>("registerOnData", _dotNetRef));
    }

    private async Task<IAsyncDisposable> RegisterOnSelectionChange()
    {
        if(xtermInteropHelper is null) throw new InvalidOperationException("XTerm interop helper is not initialized.");
        return new JSDisposeHelper(await xtermInteropHelper.InvokeAsync<IJSObjectReference>("registerOnSelectionChange", _dotNetRef));
    }

    protected async override Task OnAfterRenderAsync(bool firstRender)
    {
        if(firstRender)
        {
            _dotNetRef = DotNetObjectReference.Create(this);

            /*
            Change the {PATH} placeholder in the next line to the path of
            the collocated JS file in the app. Examples:

                ./Components/Pages/JsCollocation2.razor.js (.NET 8 or later)
                ./Pages/JsCollocation2.razor.js (.NET 7 or earlier)
            */
    //module = await jsRuntime.InvokeAsync<IJSObjectReference>("import", "./{PATH}/JsCollocation2.razor.js");
    module = await jsRuntime.InvokeAsync<IJSObjectReference>("import", "./_content/BaksteenXTerm/XTerm.razor.js");
            //terminal = await module.InvokeAsync<IJSObjectReference>("initTerminal", _terminalElementReference, _dotNetRef );
            xtermInteropHelper = await module.InvokeAsync<IJSObjectReference>("createXTermInteropHelper", _terminalElementReference);
            //onKeySubscription = await RegisterOnKey();
            onDataSubscription = await RegisterOnData();
            onSelectionChangeSubscription = await RegisterOnSelectionChange();
        }
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        if(onKeySubscription is not null)
        {
            try
            {
                await onKeySubscription.DisposeAsync();
            }
            catch(JSDisconnectedException)
            {
            }
            onKeySubscription = null;
        }

        if(onDataSubscription is not null)
        {
            try
            {
                await onDataSubscription.DisposeAsync();
            }
            catch(JSDisconnectedException)
            {
            }
            onDataSubscription = null;
        }

        if(onSelectionChangeSubscription is not null)
        {
            try
            {
                await onSelectionChangeSubscription.DisposeAsync();
            }
            catch(JSDisconnectedException)
            {
            }
            onSelectionChangeSubscription = null;
        }

        if(xtermInteropHelper is not null)
        {
            try
            {
                await xtermInteropHelper.InvokeVoidAsync("dispose");
                await xtermInteropHelper.DisposeAsync();
            }
            catch(JSDisconnectedException)
            {
            }
            xtermInteropHelper = null;
        }

        if(terminal is not null)
        {
            try
            {
                await terminal.DisposeAsync();
            }
            catch(JSDisconnectedException)
            {
            }
            terminal = null;
        }

        if(module is not null)
        {
            try
            {
                await module.DisposeAsync();
            }
            catch(JSDisconnectedException)
            {
            }
            module = null;
        }
    }

    public async Task Fit()
    {
        if(xtermInteropHelper is null) return;
        await xtermInteropHelper.InvokeVoidAsync("fit");
    }

    public async Task Write(string text)
    {
        if(xtermInteropHelper is null) return;
        await xtermInteropHelper.InvokeVoidAsync("write", text);
    }

    public async Task Clear()
    {
        if(xtermInteropHelper is null) return;
        // Call the xterm.js Terminal.clear() method via JS interop.
        // If your xterm.js version does not expose `clear`, you can
        // alternatively use `reset` or write an ANSI clear sequence.
        await xtermInteropHelper.InvokeVoidAsync("clear");
    }

    public async Task Reset()
    {
        if(xtermInteropHelper is null) return;
        // Try calling the JS `reset` method on the Terminal instance.
        await xtermInteropHelper.InvokeVoidAsync("reset");
    }

    // New: Resize via interop
    public async Task Resize(int cols, int rows)
    {
        if (xtermInteropHelper is null) return;
        await xtermInteropHelper.InvokeVoidAsync("resize", cols, rows);
    }

    public async Task Blur()
    {
        if(xtermInteropHelper is null) return;
        await xtermInteropHelper.InvokeVoidAsync("blur");
    }

    public async Task Focus()
    {
        if(xtermInteropHelper is null) return;
        await xtermInteropHelper.InvokeVoidAsync("focus");
    }

    // Selection interop methods

    public async Task<bool> HasSelection()
    {
        if (xtermInteropHelper is null) return false;
        return await xtermInteropHelper.InvokeAsync<bool>("hasSelection");
    }

    public async Task<string?> GetSelection()
    {
        if (xtermInteropHelper is null) return null;
        return await xtermInteropHelper.InvokeAsync<string>("getSelection");
    }

    public async Task<BufferRange?> GetSelectionPosition()
    {
        if (xtermInteropHelper is null) return null;
        // returns an object with { start: { x, y }, end: { x, y } } or null
        return await xtermInteropHelper.InvokeAsync<BufferRange?>("getSelectionPosition");
    }

    public async Task ClearSelection()
    {
        if (xtermInteropHelper is null) return;
        await xtermInteropHelper.InvokeVoidAsync("clearSelection");
    }

    public async Task Select(int column, int row, int length)
    {
        if (xtermInteropHelper is null) return;
        await xtermInteropHelper.InvokeVoidAsync("select", column, row, length);
    }

    public async Task SelectAll()
    {
        if (xtermInteropHelper is null) return;
        await xtermInteropHelper.InvokeVoidAsync("selectAll");
    }
}
